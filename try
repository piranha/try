#!/usr/bin/env bash
# (c) Sanya Solovyov 2025 under MIT license

set -euo pipefail
#set -x

DIR="${DIR:-${HOME}/dev/try}"
if [[ -z "${TRYRC_DISABLED:-}" ]] && [[ -f ~/.tryrc ]]; then
    . ~/.tryrc
fi

usage() {
    SCRIPT="$(cd "$(dirname "$0")" && pwd)/$(basename "$0")"

    cat <<EOF
$(basename "$0"): Browse all experiments
$(basename "$0") help: This usage info
$(basename "$0") clone http://...: Clone report from github
$(basename "$0") worktree bla bla: Select an experiment to create a new repo

Put this in your zsh/bash config:

eval "\$($SCRIPT init)"
EOF
}

init() {
    SCRIPT="$(cd "$(dirname "$0")" && pwd)/$(basename "$0")"

    cat <<EOF
try () {
  local line
  local tmpfile=\$(mktemp)

  "$SCRIPT" "\$@" > "\$tmpfile"

  while IFS= read -r line; do
    if [[ "\$line" == DO:\ * ]]; then
      eval "\${line#DO: }"
    else
      printf '%s\n' "\$line"
    fi
  done < "\$tmpfile"

  rm -f "\$tmpfile"
}
EOF
}

log() {
    echo LOG: "$@" >&2
}

record() {
    local logfile="$DIR/.trylog"
    local dirname="$(basename "$1")"
    local timestamp="$(date +%s)"

    # Remove old entry for this dir, append new one
    grep -v " $dirname\$" "$logfile" 2>/dev/null > "$logfile.tmp" || true
    echo "$timestamp $dirname" >> "$logfile.tmp"
    mv "$logfile.tmp" "$logfile"
}

mtime() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        stat -f %m "$1" 2>/dev/null || echo 0
    else
        stat -c %Y "$1" 2>/dev/null || echo 0
    fi
}

case "${1:-}" in
    --RM)
        if [[ -z "${2:-}" ]]; then
            log "You have to provide argument for removal"
            exit 0
        fi
        res=$(echo -e 'Yes\nNo' | \
                  fzf --prompt="Delete ${2}?" \
                      --no-preview \
                      --height=4 \
                      --layout=reverse)
        if [[ "$res" == "Yes" ]]; then
            rm -rf -- "$DIR/${2:-?}"
        fi
        ;;
    --LIST)
        cd "$DIR" || exit 1
        logfile="$DIR/.trylog"
        [[ ! -f "$logfile" ]] && touch "$logfile"
        now=$(date +%s)

        # Output: "mtime dirname"
        if [[ "$OSTYPE" == "darwin"* ]]; then
            stat -f "%m %N" -- * 2>/dev/null
        else
            stat -c "%Y %n" -- * 2>/dev/null
        fi | \
            # Join on dirname, filling missing access times with 0
            join -1 2 -2 2 -a1 -e 0 -o 1.1,2.1,1.2 - "$logfile" | \
             awk -v now="$now" '{
                 mtime=$1
                 access=$2
                 dirname=$3

                 score = 0
                 if (mtime > 0) score += 2000 / ((now - mtime) / 86400 + 10)
                 if (access > 0) score += 3000 / ((now - access) / 3600 + 10)
                 printf "%010d %s\n", score, dirname
            }' | sort -rn | cut -d' ' -f2
        ;;
    --TARGET)
        target="$DIR/$(date +%y%m%d)-${2// /-}"
        mkdir -p "$target"
        echo "$target"
        ;;
    --help|help)
        usage
        ;;
    init)
        init
        ;;
    clone)
        if [[ -z "${2:-}" ]]; then
            echo "Usage: $0 clone https://url/to/repo"
            exit 0
        fi
        reponame=$(basename "$2" | sed 's/[?#].*//' | sed 's/\.git$//')
        target="$("$0" --TARGET "$reponame")"
        git clone "$2" "$target"
        echo DO: cd "$target"
        ;;
    worktree) # worktree src [target]
        src=$(cd "${2:-.}" && pwd)
        if [[ "$(cd "$src" && git rev-parse --is-inside-work-tree 2>/dev/null)" != "true" ]]; then
           echo "Not inside of a git repo!"
           exit 1
        fi
        target="$(echo "${3:-$(basename "$src")}" | sed 's/^[0-9]\{6\}-//')"
        target="$("$0" --TARGET "$target")"
        (cd "$src" && git worktree add "$target")
        echo DO: cd "$target"
        ;;
    .)
      "$0" worktree "${2:-}"
      ;;
    "https://"*)
        "$0" clone "${1:-}"
        ;;
    --FZF)
        fzf --ansi \
            --no-select-1 \
            --no-exit-0 \
            --query="${2:-}" \
            --preview "ls $DIR/{}" \
            --print-query \
            --bind "start,ctrl-r:reload($0 --LIST)" \
            --bind "enter:accept-or-print-query" \
            --bind "alt-backspace:become($0 --RM {1}; $0 --FZF)"\
            --height '~50%' \
            --header 'Type to filter/create | Enter=select | Alt-BS=delete'
        ;;
    *)
        result=$("$0" --FZF "${1:-}")

        query=$(echo "$result" | head -1)
        selected=$(echo "$result" | tail -1)

        target=""

        # If nothing selected but query exists, create new
        # fzf will output only a single line if there is query but no selection
        if [[ -z "$selected" || "$selected" == "$query" ]]; then
            if [[ -n "$query" ]]; then
                target=$("$0" --TARGET "$query")
            fi
        else
            target="$DIR/$selected"
        fi

        if [[ -n "$target" ]]; then
            record "$target"
            echo DO: cd "$target"
        fi
        ;;
esac
